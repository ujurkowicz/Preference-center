<html>
  <head>
    <title>Preference Center</title>
    <link
      rel="stylesheet"
      href="https://mc4ysf601b734wwpkwz81pbkx1p0.pub.sfmc-content.com/0pjgty5bdgr"
    />
  </head>
  <body>
    <!-- ERROR WINDOW  -->
    <div id="ajaxErrorWindow" class="hidden errorWindow">
      <p class="errorTxt">Error has occured</p>
      <a style="cursor: pointer" onclick="hideWindow('ajaxErrorWindow')">X</a>
    </div>
    <!-- LOGIN  -->
    <div id="login">
      <h1>LOG IN</h1>
      <div class="container">
        <form id="form1" method="post">
            <label for="Email Address">Email Address</label>
            <input id="emailInput" type="email" name="EmailAddress" required />
          <input name="submitted" type="hidden" value="true" />
          <button type="submit">Next</button>
        </form>
      </div>
    </div>

    <!--AUTHENTICATION -->
    <div id="authentication" class="hidden">
      <div id="errorWindow" class="hidden errorWindow">
        <p class="errorTxt">Error has occured</p>
        <a style="cursor: pointer" onclick="hideWindow('errorWindow')">X</a>
      </div>
      <h1>AUTHENTICATION</h1>
      <div class="authInfo">
        <p id="authText"></p>
      </div>
      <form id="form2" method="post">
          <label for="VerificationCode">Verification code</label>
          <input id="token" type="number" name="VerificationCode" required />
        <input name="submitted" type="hidden" value="true" />
        <div class="btns-container">
          <button id="authBackBtn">Back</button>
          <button type="submit">Next</button>
        </div>
      </form>
    </div>

    <!--PERSONAL DATA FORM -->
    <div id="dataForm" class="hidden">
      <h1>PERSONAL DATA FORM</h1>
      <form id="form3" method="post">
          <label for="FirstName">First Name*</label>
          <input type="text" name="FirstName" id="fname" required />
          <label for="LastName">Last Name*</label>
          <input type="text" name="LastName" id="lname" required />
          <label for="Phone">Phone</label>
          <input type="tel" id="Phone" name="Phone" pattern="[+0-9]{9,13}"
          oninvalid="this.setCustomValidity('Enter a phone number')"
          oninput="this.setCustomValidity('')">
          <label for="Country" id="country">Country*</label>
          <select name="Country" onchange="getCountry()">
            <option value="anglia">England</option>
            <option value="belgia">Belgium</option>
            <option value="chorwacja">Croatia</option>
            <option value="polska">Poland</option>
            <option value="usa">USA</option>
          </select>
        <fieldset class="hidden region">
          <label for="Region">Region</label>
          <select name="Region">
            <option value="dolnoslaskie">Dolnośląskie</option>
            <option value="kujawsko-pomorskie">Kujawsko-pomorskie</option>
            <option value="lubelskie">Lubelskie</option>
            <option value="lubuskie">Lubuskie</option>
            <option value="lodzkie">Łódzkie</option>
            <option value="malopolskie">Małopolskie</option>
            <option value="mazowieckie">Mazowieckie</option>
            <option value="opolskie">Opolskie</option>
            <option value="podkarpackie">Podkarpackie</option>
            <option value="podlaskie">Podlaskie</option>
            <option value="pomorskie">Pomorskie</option>
            <option value="slaskie">Śląskie</option>
            <option value="swietokrzyskie">Świętokrzyskie</option>
            <option value="warminsko-mazurskie">Warmińsko-mazurskie</option>
            <option value="wielkopolskie">Wielkopolskie</option>
            <option value="zachodniopomorskie">Zachodniopomorskie</option>
          </select>
        </fieldset>
        <input name="submitted" type="hidden" value="true" />
        <div class="btns-container">
          <button id="dataFormBackBtn">Back</button>
          <button type="submit">Next</button>
        </div>
      </form>
    </div>

    <!--SUBSCRIPTION FORM -->
    <div id="subscriptionForm" class="hidden">
      <form id="form4">
        <h2>What are your area of interests?</h2>
        <fieldset>
          <div class="preferences">
          </div>
        </fieldset>
        <h2>What kind of the notifications do you want to get?</h2>
        <fieldset>
          <div class="notifications">
          </div>
        </fieldset>
        <button id="unsubscribe">Unsubscribe</button>
        <div class="btns-container">
          <button id="back">Back</button>
          <input name="submitted" type="hidden" value="true" />
          <button type="submit">Next</button>
        </div>
      </form>
      <div id="confirm" class="hidden">
        <div class="backgroundContainer"></div>
        <div class="messageContainer">
          <div id="confirmMessage">Are you sure you want to unsubscribe?</div>
          <div class="btns-container">
            <input id="confirmYes" type="button" value="Yes" />
            <input id="confirmNo" type="button" value="Cancel" />
          </div>
        </div>
      </div>
    </div>

    <!--MARKETING CONSENT FORM-->
    <div id="marketingForm" class="hidden">
      <h1>MARKETING CONSENT</h1>
      <form id="form5" method="post">
        <div class="marketingConsent">
          <input type="checkbox" id="marketingConsent1" name="marketingConsent1" value="marketingConsent1" required style="display: inline-block; margin-top: 7px;">
          <label for="marketingConsent1" >I have read and understood the Privacy Notice containing information about the processing of my personal data, which is part of my consent given below. I consent to the processing of my personal data (to the extent described in the Privacy Notice) for marketing purposes. <span class="required">*</span></label><br>
        </div>
        <div class="marketingConsent">
          <input type="checkbox" id="marketingConsent2" name="marketingConsent2" value="marketingConsent2" required style="display: inline-block; margin-top: 7px;">
          <label for="marketingConsent2">I consent to the processing of my personal data (to the extent described in the Privacy Notice) for direct marketing purposes. <span class="required">*</span></label></label><br>
        </div>
        <div class="btns-container">
          <button id="marketingConsentBackBtn">Back</button>
          <button type="submit">Next</button>
        </div>
      </form>
    </div>

     <!--THANK YOU PAGE-->
     <div id="thankYou" class="hidden">
      <img id="thankYouImg"  alt="thankYou"
      src="https://image.s50.sfmc-content.com/lib/fe3611717564047a721475/m/1/c826113b-0dcd-4657-b503-380d12da6a91.jpg">
      <p>Your submission has been saved.</p>
    </div>

    <!--SPINNER-->
    <div id="loading-background" class="loading-background">
    </div>
    <div class="spinner-container">
      <div id="spinner-background" class="spinner-background">
        <div class="lds-ring">
          <div></div><div></div><div></div><div></div>
        </div>
      </div>
    </div>

    <script type="text/javascript">
      window.onload = function(e) {
        e.preventDefault();
        hideSpinner();
      }

      function showSpinner() {
        document.getElementById("loading-background").style.display = "block";  
        document.getElementById("spinner-background").style.display = "block"; 
      }

      function hideSpinner() {
        document.getElementById("loading-background").style.display = "none";  
        document.getElementById("spinner-background").style.display = "none"; 
      }

      document.getElementById('authBackBtn').addEventListener('click', () => {
        hideWindow('authentication');
        showWindow(event, 'login');
      });

      document.getElementById('dataFormBackBtn').addEventListener('click', () => {
        hideWindow('dataForm');
        showWindow(event, 'login');
      });

      document.getElementById('marketingConsentBackBtn').addEventListener('click', () => {
        hideWindow('marketingForm');
        showWindow(event, 'subscriptionForm');
      })

      let form1 = document.querySelector("#form1");
      form1.addEventListener("submit", emailSubmit, false);

      let form2 = document.querySelector("#form2");
      form2.addEventListener("submit", tokenSubmit, false);
      var email = document.querySelector("input[type=email]");

      let form3 = document.querySelector("#form3");
      form3.addEventListener("submit", dataFormSubmit, false);

      let backBtn = document.querySelector("#back");
      backBtn.addEventListener("click", backtoDataForm, false);

      let form4 = document.querySelector("#form4");
      form4.addEventListener("submit", subFormSubmit, false);

      let form5 = document.querySelector("#form5");
      form5.addEventListener("submit", subMarketingConsents, false);

      let unsubscribeBtn = document.querySelector("#unsubscribe");
      unsubscribeBtn.addEventListener("click", () => { showWindow(event,'confirm') }, false);

      let cancelMessage = document.querySelector('#confirmNo');
      cancelMessage.addEventListener("click", () => { hideWindow('confirm') }, false);

      let confirmUnsubscribe = document.querySelector('#confirmYes');
      confirmUnsubscribe.addEventListener("click", unsubscribe, false);

      var subscriberKey;

      function emailSubmit(e) {
        e.preventDefault();
        var page = "login";
        var xhr = new XMLHttpRequest();
        showSpinner();
        xhr.onload = function () {
          if (xhr.status >= 200 && xhr.status < 300) {
            var response = JSON.parse(xhr.response);
            let email = document.getElementById("emailInput").value;
            let authText = document.getElementById("authText");
            authText.textContent=`The verification code has been sent to ${email}`;

            hideWindow('login');
            showWindow(event, 'authentication');
            hideSpinner();

          } else {
            let error=xhr.status+' '+xhr.statusText;
            showError(error);
            hideSpinner();
          }
        };
        xhr.open(
          "POST",
          "https://mc4ysf601b734wwpkwz81pbkx1p0.pub.sfmc-content.com/xvbwhkqetqp?EmailAddress=" +
            email.value +
            "&page=" +
            page
        );
        xhr.send();
      }

      function tokenSubmit(e) {
        e.preventDefault();
        var token = document.querySelector("#token");
        var page = "authentication";
        var xhr = new XMLHttpRequest();
        showSpinner();
        xhr.onload = function () {
          if (xhr.status >= 200 && xhr.status < 300) {
            var response = JSON.parse(xhr.response);
            if (response["Error"] == null) {
              hideWindow('authentication');
              showWindow(event, 'dataForm');
              hideSpinner();
            } else {
              showError(response["Error"]);
              hideSpinner();
            }
          } else {
            let error=xhr.status+' '+xhr.statusText;
            showError(error);
            hideSpinner();
          }
        };
        xhr.open(
          "POST",
          "https://mc4ysf601b734wwpkwz81pbkx1p0.pub.sfmc-content.com/xvbwhkqetqp?token=" +
            token.value +
            "&page=" +
            page +
            "&EmailAddress=" +
            email.value
        );
        xhr.send();
      }

      function getCountry() {
        var country = document.querySelector("select").value;
        if (country == "polska") {
          document.querySelector(".region").classList.remove("hidden");
        } else if (
          !document.querySelector(".region").classList.contains("hidden")
        ) {
          document.querySelector(".region").classList.add("hidden");
        }
        return country;
      }

      function dataFormSubmit(e) {
        e.preventDefault();
        var page = "dataForm";
        var country = getCountry();
        var firstName = document.querySelector("#fname").value;
        var lastName = document.querySelector("#lname").value;
        var phone = document.querySelector("input[type=tel]").value;
        let region = document.querySelector(".region").value;
        region = region == undefined ? "" : region;
        showSpinner();
        var xhr = new XMLHttpRequest();
        xhr.onload = function () {
          if (xhr.status >= 200 && xhr.status < 300) {
            let response = JSON.parse(xhr.response);
            let previousPrefAreas=response.CheckedPreferenceAreas;
            let previousNotifications = response.CheckedNotifications;
            subscriberKey=response.SubscriberKey;

            hideWindow('dataForm');
            showWindow(event, 'subscriptionForm');
            showPreferences(response.PreferenceAreas, previousPrefAreas);
            showNotifications(response.Notifications, previousNotifications);
            hideSpinner();
          } else {
            let error=xhr.status+' '+xhr.statusText;
            showError(error);
            hideSpinner();
          }
        };
        xhr.open(
          "POST",
          "https://mc4ysf601b734wwpkwz81pbkx1p0.pub.sfmc-content.com/xvbwhkqetqp?page=" +
            page +
            "&firstName=" +
            firstName +
            "&lastName=" +
            lastName +
            "&country=" +
            country +
            "&phone=" +
            phone +
            "&region=" +
            region +
            "&EmailAddress=" +
            email.value +
            "&SubscriberKey=" +
            subscriberKey
        );
        xhr.send();
      }
      
      function showPreferences(prefArr, checkedPrefArr){
        let preferences = document.querySelector('.preferences');
        preferences.innerHTML='';
        for (let i=0; i<prefArr.length; i++) {
          let prefId='p'+prefArr[i].Id;
          let pref = "pref"+(i+1).toString();
          let checked=false;
          for (let j=0; j<checkedPrefArr.length; j++) {
            if (prefArr[i].Id==checkedPrefArr[j].AreaId) {
               checked = true;
              break;
            }
          }
          preferences.innerHTML+=checked?
         `<input type="checkbox" class="pref" id=${prefId} name=${pref} checked/><label for=${prefId}>`+prefArr[i].Asset+'</label><p>'+prefArr[i].Description+'</p>':
         `<input type="checkbox" class="pref" id=${prefId} name=${pref} /><label for=${prefId}>`+prefArr[i].Asset+'</label><p>'+prefArr[i].Description+'</p>';          
        }
      }

      function showNotifications(notArr, checkedNotArr){
        let notifications = document.querySelector('.notifications');
        notifications.innerHTML='';
        for (let i=0; i<notArr.length; i++) {
          let notId='n'+notArr[i].Id;
          let not="not"+(i+1).toString();
          let checked=false;
          for (let j=0; j<checkedNotArr.length; j++) {
            if (notArr[i].Id==checkedNotArr[j].NotificationId) {
               checked = true;
              break;
            }
          }
          notifications.innerHTML+=checked?
          `<div><input type="checkbox" class="not" id=${notId} name=${not} checked/><label for=${notId}>`+notArr[i].Asset+'</label><p>'+notArr[i].Description+'</p></div>':
          `<div><input type="checkbox" class="not" id=${notId} name=${not}/><label for=${notId}>`+notArr[i].Asset+'</label></div><p>'+notArr[i].Description+'</p>';
          
        }
      }

      function backtoDataForm(e) {
        e.preventDefault();
        hideWindow('subscriptionForm');
        showWindow(event, 'dataForm');
      }

      function subFormSubmit(e) {
        e.preventDefault();
        var page = "subscriptionForm";
        var xhr = new XMLHttpRequest();   
        //get checked consents
        let prefAreasIds=[];
        let notificationsIds=[];

        let prefAreas = document.querySelectorAll('.pref:checked');
        let notifications = document.querySelectorAll('.not:checked');

        prefAreas.forEach(el=>prefAreasIds.push(el.id.slice(1)));
        notifications.forEach(el=>notificationsIds.push(el.id.slice(1)));

        showSpinner();
        xhr.onload = function () {
          if (xhr.status >= 200 && xhr.status < 300) {
            var response = JSON.parse(xhr.response);
            if (response["Error"] == null) {
              hideWindow('subscriptionForm');
              showWindow(event, 'marketingForm');
              hideSpinner();
            } else {
              showError(response["Error"]);
              hideSpinner();
            }
          } else {
            let error=xhr.status+' '+xhr.statusText;
            showError(error);
            hideSpinner();
          }
        };
        xhr.open(
          "POST",
          "https://mc4ysf601b734wwpkwz81pbkx1p0.pub.sfmc-content.com/xvbwhkqetqp?page=" +
            page +
            "&prefAreasIds=" +
            prefAreasIds +
            "&notificationsIds=" +
            notificationsIds +
            "&SubscriberKey=" +
            subscriberKey 
        );
        xhr.send();
      }

      function unsubscribe(){
        var page = "unsubscribe";
        var xhr = new XMLHttpRequest();
        showSpinner();
        xhr.onload = function () {
          if (xhr.status >= 200 && xhr.status < 300) {
            hideWindow('subscriptionForm');
            showWindow(event, 'thankYou');
            var response = JSON.parse(xhr.response);
            hideSpinner();
          } else {
            let error=xhr.status+' '+xhr.statusText;
            showError(error);
            hideSpinner();
          }
        };
        xhr.open(
          "POST",
          "https://mc4ysf601b734wwpkwz81pbkx1p0.pub.sfmc-content.com/xvbwhkqetqp?page=" +
            page +
            "&SubscriberKey=" +
            subscriberKey +
            "&EmailAddress=" +
            email.value
        );
        xhr.send();
      }

      function subMarketingConsents(e){
        e.preventDefault();
        hideWindow('marketingForm');
        showWindow(event, 'thankYou');
      }

      function showError(err) {
        var errorWindow = document.querySelector(".errorWindow");
        errorWindow.classList.remove("hidden");
        var errorTxt = document.querySelector(".errorTxt");
        errorTxt.innerHTML = err;
      }

      function hideWindow(id) {
        document.getElementById(id).classList.add('hidden');
      }

      function showWindow(e, id) {
        e.preventDefault();
        document.getElementById(id).classList.remove('hidden');
      }

    </script>
  </body>
</html>
