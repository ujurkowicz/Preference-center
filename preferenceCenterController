<script language="ampscript" runat="server">

    set @TOKEN_DE = 'Verification Tokens'
    set @MDE = 'MDE'
    set @PREFERENCE_AREAS_DE= 'Preference Areas'
      
    var @page,
    var @emailAddress,
    var @token,
    var @expirationDate,
    var @isUsed

    /*set @subscriberKey = 'x'*/
    set @page=RequestParameter('page')
      
    IF (@page=='login') THEN
        set @emailAddress=RequestParameter('EmailAddress')
        set @token=random(100000,999999)
        set @expirationDate=DateAdd(Now(), 1, "H")
        set @isUsed=False
        UpsertDE(@TOKEN_DE,1,"EmailAddress", @emailAddress, "Token", @token, "ExpirationDate", @expirationDate, "IsUsed", @isUsed)
      
    ELSEIF (@page=='authentication') THEN
        var  @rows,  @rowCount, @row, @error

        set @emailAddress=RequestParameter('EmailAddress')
        set @rows = LookupRows(@TOKEN_DE,"EmailAddress", @emailAddress)
        set @rowCount = rowCount(@rows)

        IF @rowCount > 0 THEN

            /*sprawdz token i czy wazny i czy nie zuzyty*/   

            set @row = row(@rows, 1)
            set @token = field(@row, "Token")

            IF (RequestParameter("token") == @token) THEN
                set @expirationDate = field(@row, "ExpirationDate")

                IF (Now() <= @expirationDate) THEN
                    set @isUsed = field(@row, "isUsed")

                    IF (@isUsed == False) THEN 
                        UpsertDE(@TOKEN_DE,1,"EmailAddress", @emailAddress, "IsUsed", "True")

                    ELSE
                           set @error= 'The verification code has been used'
                    ENDIF
                ELSE 
                    set @error = 'The verification code has expired'
                ENDIF
            ELSE 
                set @error = 'Incorrect verification code provided'
            ENDIF 
        ELSE 
            set @error = 'No email provided'
        ENDIF
    ELSEIF (@page=='dataForm') THEN
        IF isNull(@subscriberKey) THEN
            set @subscriberKey = AttributeValue('_subscriberkey')
        ENDIF
    /*UKC-003C*/
        var @firstName, @lastName, @country, @phone, @region

        set @emailAddress = RequestParameter('EmailAddress')
        set @firstName = RequestParameter('firstName')
        set @lastName = RequestParameter('lastName')
        set @phone = RequestParameter('phone')
        set @country = RequestParameter('country')
        set @region = RequestParameter('region')

        IF (@subscriberKey=='') THEN
            /*CREATE SALESFORCE CONTACT, TAKE ITS ID AS SUBSCRIBERKEY IN MDE*/
            var @subscriberKey
            set @subscriberKey = CreateSalesforceObject (
                "Contact", 3,
                "FirstName", @firstName,
                "LastName", @lastName,
                "Email", @emailAddress
            )
            UpsertDE(@MDE,1,'SubscriberKey', @subscriberKey, "EmailAddress", @emailAddress,
            'FirstName', @firstName, 'LastName', @lastName, 'Country', @country, 'Phone', @phone, 'Region', @region)
        ELSE
            /*UPSERT MDE*/
            UpsertDE(@MDE,1,'SubscriberKey', @subscriberKey, "EmailAddress", @emailAddress,
            'FirstName', @firstName, 'LastName', @lastName, 'Country', @country, 'Phone', @phone, 'Region', @region)
        ENDIF
        /*GET RECORDS FROM PREFERRENCE AREAS AND NOTIFICATION DE*/
        var @id, var @area, var @description


    ELSEIF (@page=='subscriptionForm') THEN
    /*UKC -404*/
    ENDIF

</script>
<script type="text/javascript" runat="server">
    var PREFERNCE_AREAS_DE_EK='A8AAE3B1-9927-477E-AFC5-51D98774F723';
    var NOTIFICATIONS_DE_EK='FE5B10AD-4155-4087-99CF-3B2D932C8F56';
    
    Platform.Load("core", "1");
            
    var page = Variable.GetValue("@page");
    var token = Variable.GetValue("@token");
    var error = Variable.GetValue("@error");
    var email = Variable.GetValue("@emailAddress");
    var subscriberKey = Variable.GetValue("@subscriberKey");

    var preferenceAreasDE = DataExtension.Init(PREFERNCE_AREAS_DE_EK);
    var preferenceAreas = preferenceAreasDE.Rows.Retrieve();
    var notificationsDE = DataExtension.Init(NOTIFICATIONS_DE_EK);
    var notifications = notificationsDE.Rows.Retrieve();

    var result= { 
        Page: page,
        Token: token,
        Error: error,
        Email: email,
        SubscriberKey: subscriberKey,
        PreferenceAreas: preferenceAreas,
        Notifications: notifications
        }
    stringifiedResult = Stringify(result);
          
</script>
<ctrl:var name=stringifiedResult />